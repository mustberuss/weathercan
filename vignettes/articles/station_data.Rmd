---
title: "Homogenizing ECCC Data from weathercan"
author: "Russ Allen"
date: "2025-03-03"
output: rmarkdown::html_document
---



ECCC weather stations are sometimes replaced, meaning that a new station id is created for data coming from the same location.
It can be tricky to amalgamate data from these stations.   
See the original discussion in [issue 17](https://github.com/ropensci/weathercan/issues/117)

Here we'll take an initial look to see what, if anything, can be done
programmatically to identify these locations.   
Inspired by the two answers in a [gis.stackexchange post](https://gis.stackexchange.com/questions/437968/r-finding-closest-point-to-each-point-and-filtering-which-points-to-consider)


``` r
library(weathercan)
library(tidyverse)
library(sf)

myData <- stations()

# dedup on "station_id"
unique_stations <- myData[!duplicated(myData[,c('station_id')]),]

df <- st_as_sf(unique_stations, coords = c("lat", "lon")) 

# Compute the pairwise distances.  
dm <- st_distance(df)

# Lets build an n x n grid to keep track of the pairwise distances
n <- dim(dm)[[1]]
tracking <- data.frame(expand.grid(i=1:n, j=1:n))
tracking$distance <- c(dm)

# add the two columns of station_ids, where the second answer added df$year
tracking$stn_id.i = df$station_id[tracking$i]
tracking$stn_id.j = df$station_id[tracking$j]

# We only need to compare one way, distance(a, b) would be the same as 
# distance (b, a) and we don't need to compare distance(a, a) 
# so we'll only consider rows where i > j 

tracking <- tracking[tracking$i > tracking$j,]
dim(tracking)
```

```
## [1] 38838891        5
```

``` r
# so 38.8M comparisons?!!
# Ok, so lets just look at the closest ones possible

tracking <- tracking[tracking$distance == 0.00,]
dim(tracking)
```

```
## [1] 1063    5
```

``` r
# That's still more than I want to check by hand! Is there a weathercan intern?
str(tracking)
```

```
## 'data.frame':	1063 obs. of  5 variables:
##  $ i       : int  1157 73 1159 1236 1159 1236 1220 1178 115 127 ...
##  $ j       : int  60 70 70 70 73 73 74 76 114 125 ...
##  $ distance: num  0 0 0 0 0 0 0 0 0 0 ...
##  $ stn_id.i: num  27212 1867 27214 31427 27214 ...
##  $ stn_id.j: num  1854 1864 1864 1864 1867 ...
```

``` r
# quick sanity check, grab a few pairs of supposedly matching stations
# The date ranges on the first pair don't overlap 
for(k in 1:3) {
  print(paste("Compare pair", k))
  check_pair <- c(tracking$stn_id.i[[k]], tracking$stn_id.j[[k]])
  str(unique_stations[unique_stations$station_id %in% check_pair,])
}
```

```
## [1] "Compare pair 1"
## tibble [2 × 17] (S3: tbl_df/tbl/data.frame)
##  $ prov             : chr [1:2] "AB" "AB"
##  $ station_name     : chr [1:2] "CORONATION A" "CORONATION CLIMATE"
##  $ station_id       : num [1:2] 1854 27212
##  $ climate_id       : chr [1:2] "3011880" "3011887"
##  $ WMO_id           : num [1:2] NA 71318
##  $ TC_id            : chr [1:2] NA "WCT"
##  $ lat              : num [1:2] 52.1 52.1
##  $ lon              : num [1:2] -111 -111
##  $ elev             : num [1:2] 791 791
##  $ tz               : chr [1:2] "Etc/GMT+7" "Etc/GMT+7"
##  $ interval         : chr [1:2] "day" "day"
##  $ start            : num [1:2] 1944 1996
##  $ end              : num [1:2] 1994 2025
##  $ normals          : logi [1:2] TRUE TRUE
##  $ normals_1991_2020: logi [1:2] TRUE TRUE
##  $ normals_1981_2010: logi [1:2] FALSE FALSE
##  $ normals_1971_2000: logi [1:2] TRUE FALSE
## [1] "Compare pair 2"
## tibble [2 × 17] (S3: tbl_df/tbl/data.frame)
##  $ prov             : chr [1:2] "AB" "AB"
##  $ station_name     : chr [1:2] "EDMONTON CALDER" "EDMONTON CITY CENTRE A"
##  $ station_id       : num [1:2] 1864 1867
##  $ climate_id       : chr [1:2] "3012203" "3012208"
##  $ WMO_id           : num [1:2] NA NA
##  $ TC_id            : chr [1:2] NA NA
##  $ lat              : num [1:2] 53.6 53.6
##  $ lon              : num [1:2] -114 -114
##  $ elev             : num [1:2] 671 671
##  $ tz               : chr [1:2] "Etc/GMT+7" "Etc/GMT+7"
##  $ interval         : chr [1:2] "day" "day"
##  $ start            : num [1:2] 1975 1937
##  $ end              : num [1:2] 1977 2005
##  $ normals          : logi [1:2] FALSE TRUE
##  $ normals_1991_2020: logi [1:2] FALSE TRUE
##  $ normals_1981_2010: logi [1:2] FALSE TRUE
##  $ normals_1971_2000: logi [1:2] FALSE TRUE
## [1] "Compare pair 3"
## tibble [2 × 17] (S3: tbl_df/tbl/data.frame)
##  $ prov             : chr [1:2] "AB" "AB"
##  $ station_name     : chr [1:2] "EDMONTON CALDER" "EDMONTON BLATCHFORD"
##  $ station_id       : num [1:2] 1864 27214
##  $ climate_id       : chr [1:2] "3012203" "3012209"
##  $ WMO_id           : num [1:2] NA 71157
##  $ TC_id            : chr [1:2] NA "XEC"
##  $ lat              : num [1:2] 53.6 53.6
##  $ lon              : num [1:2] -114 -114
##  $ elev             : num [1:2] 671 671
##  $ tz               : chr [1:2] "Etc/GMT+7" "Etc/GMT+7"
##  $ interval         : chr [1:2] "day" "day"
##  $ start            : num [1:2] 1975 1996
##  $ end              : num [1:2] 1977 2025
##  $ normals          : logi [1:2] FALSE TRUE
##  $ normals_1991_2020: logi [1:2] FALSE TRUE
##  $ normals_1981_2010: logi [1:2] FALSE FALSE
##  $ normals_1971_2000: logi [1:2] FALSE FALSE
```
Lets create a function that will help us investigate "close" stations. 


``` r
see_also_stations <- function(station_id) {
  c(tracking[tracking$stn_id.i == station_id, "stn_id.j"],
    tracking[tracking$stn_id.j == station_id, "stn_id.i"])
}

see_also_stations(tracking$stn_id.i[[1]])
```

```
## [1] 1854
```

``` r
see_also_stations(tracking$stn_id.j[[1]])
```

```
## [1] 27212
```

One last quick check here to see if there are more than pairs in common.
There's probably a cooler way to do this, but I'm dying to know the answer!


``` r
combined <- c(tracking$stn_id.i, tracking$stn_id.j)

# for just getting the frequency distribution
counts <- as.data.frame(combined) %>%
  count(combined, sort = TRUE, name= "Code_frequency")

head(counts)
```

```
##   combined Code_frequency
## 1     1737              5
## 2     8271              5
## 3    42803              5
## 4    47428              5
## 5    51177              5
## 6    51218              5
```

``` r
look_at <- see_also_stations(counts$combined[[1]])
look_at
```

```
## [1]  8271 42803 47428 51177 51218
```

``` r
# lets sort by evation to see if any of these could really 
# be the same place
compare <- unique_stations[unique_stations$station_id %in% look_at,] %>%
  arrange(elev)

str(compare)
```

```
## tibble [5 × 17] (S3: tbl_df/tbl/data.frame)
##  $ prov             : chr [1:5] "NU" "NU" "NU" "NU" ...
##  $ station_name     : chr [1:5] "QIKIQTARJUAQ A" "QIKIQTARJUAQ A" "QIKIQTARJUAQ AWOS" "QIKIQTARJUAQ A" ...
##  $ station_id       : num [1:5] 51177 8271 47428 51218 42803
##  $ climate_id       : chr [1:5] "2400576" "2400572" "2400571" "2400577" ...
##  $ WMO_id           : num [1:5] NA 71338 71338 NA 71357
##  $ TC_id            : chr [1:5] "YVM" "YVM" "YVM" "YVM" ...
##  $ lat              : num [1:5] 67.5 67.5 67.5 67.5 67.5
##  $ lon              : num [1:5] -64 -64 -64 -64 -64
##  $ elev             : num [1:5] 4.9 5.5 5.5 5.5 6.4
##  $ tz               : chr [1:5] "Etc/GMT+5" "Etc/GMT+5" "Etc/GMT+5" "Etc/GMT+5" ...
##  $ interval         : chr [1:5] "day" "day" "day" "day" ...
##  $ start            : num [1:5] NA 1994 2008 2013 2005
##  $ end              : num [1:5] NA 2016 2013 2025 2025
##  $ normals          : logi [1:5] FALSE TRUE TRUE TRUE TRUE
##  $ normals_1991_2020: logi [1:5] FALSE TRUE TRUE TRUE TRUE
##  $ normals_1981_2010: logi [1:5] FALSE FALSE FALSE FALSE FALSE
##  $ normals_1971_2000: logi [1:5] FALSE FALSE FALSE FALSE FALSE
```
